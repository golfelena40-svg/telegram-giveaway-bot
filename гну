import json
import random
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
TOKEN = "8111521634:AAGLyLy4EHL3ZiZfaaWQ5tEoDWEuw-_CKgM"
CHANNEL_USERNAME = "@plemyagnu"  # –∫–∞–Ω–∞–ª —Å—Ç—É–¥–∏–∏
ADMIN_ID = @amelkina.g  # –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π Telegram ID
USERS_FILE = "users.json"

bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

def load_users():
    try:
        with open(USERS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return []

def save_users(users):
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump(users, f, ensure_ascii=False, indent=2)

@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    kb = InlineKeyboardMarkup(row_width=1)
    kb.add(
        InlineKeyboardButton("üì≤ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url="https://t.me/plemyagnu"),
        InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å", callback_data="check")
    )
    text = (
        "üèãÔ∏è‚Äç‚ôÄÔ∏è –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ä–æ–∑—ã–≥—Ä—ã—à –æ—Ç —Å—Ç—É–¥–∏–∏ <b>–ü–ª–µ–º—è –ì–ù–£</b>!\n\n"
        "üéÅ –ü—Ä–∏–∑ ‚Äî –º–µ—Å—è—Ü –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!\n\n"
        "–ß—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å:\n"
        "1Ô∏è‚É£ –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª {ch}\n"
        "2Ô∏è‚É£ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É üëá"
    ).format(ch=CHANNEL_USERNAME)
    await message.answer(text, parse_mode="HTML", reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data == "check")
async def check(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    try:
        member = await bot.get_chat_member(CHANNEL_USERNAME, user_id)
        if member.status in ["member", "administrator", "creator"]:
            users = load_users()
            if user_id not in users:
                users.append(user_id)
                save_users(users)
                await callback.message.answer("‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢—ã —É—á–∞—Å—Ç–≤—É–µ—à—å –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ üéâ")
            else:
                await callback.message.answer("‚ö†Ô∏è –¢—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—à—å üòâ")
        else:
            await callback.message.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª @plemyagnu.")
    except:
        await callback.message.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")

@dp.message_handler(commands=["draw"])
async def draw(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("üö´ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.")
        return

    users = load_users()
    if not users:
        await message.answer("‚ùå –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.")
        return

    winner = random.choice(users)
    await message.answer(
        f"üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <a href='tg://user?id={winner}'>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</a>\n\n"
        "üéÅ –¢—ã –≤—ã–∏–≥—Ä–∞–ª –º–µ—Å—è—Ü –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ <b>–ü–ª–µ–º—è –ì–ù–£</b>!",
        parse_mode="HTML"
    )

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
